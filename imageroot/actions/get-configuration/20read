#!/usr/bin/env python3

import os
import subprocess
import sys
import argparse


def load_env(env_file="/etc/lemonldap-ng/env"):
    """
    Load environment variables from a file, without overwriting existing ones.
    """
    if os.path.exists(env_file):
        with open(env_file) as f:
            for line in f:
                if '=' in line:
                    key, val = line.strip().split('=', 1)
                    os.environ.setdefault(key, val)


def run_command(cmd, shell=False, capture_output=False):
    """
    Wrapper for subprocess.run. Returns CompletedProcess.
    """
    return subprocess.run(cmd, shell=shell, check=True, text=True, capture_output=capture_output)


def get_ssodomain():
    """
    Determine SSODOMAIN either from env or by querying LemonLDAP-NG.
    """
    ssodomain = os.getenv("SSODOMAIN")
    if ssodomain:
        return ssodomain
    # fallback: fetch from lemonldap-ng-cli inside container
    try:
        cp = run_command([
            "podman", "exec", "lemonldapng-app",
            "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli",
            "-yes", "1", "get", "domain"
        ], capture_output=True)
        out = cp.stdout.strip()
        # expected format: 'domain = foo.bar'
        if '=' in out:
            return out.split('=', 1)[1].strip()
        return out
    except subprocess.CalledProcessError:
        return None


def add_sample_apps():
    ssodomain = get_ssodomain()
    if not ssodomain:
        print("SSODOMAIN is not set and could not retrieve domain; aborting.")
        sys.exit(1)

    # respect toggle unless forced
    if os.getenv("SAMPLE_APPS_STATUS", "True") != "True" and not args.force:
        print("SAMPLE_APPS_STATUS is not enabled. Use --force to override.")
        sys.exit(0)

    # skip creation if already present (first-boot instances)
    if not args.force:
        try:
            run_command([
                "podman", "exec", "lemonldapng-app",
                "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1",
                "get", "applicationList/1sample"
            ])
            print("Sample applications already exist; skipping creation.")
            return
        except subprocess.CalledProcessError:
            pass  # not present, continue

    print(f"Creating sample apps for {ssodomain}...")
    # create category
    run_command([
        "podman", "exec", "lemonldapng-app",
        "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1",
        "addKey", "applicationList/1sample", "type", "category",
        "applicationList/1sample", "catname", "Sample applications"
    ])
    # app1
    run_command([
        "podman", "exec", "lemonldapng-app",
        "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1",
        "addKey", "applicationList/1sample/test1", "type", "application"
    ])
    run_command([
        "podman", "exec", "lemonldapng-app", "bash", "-c",
        f"/usr/share/lemonldap-ng/bin/lemonldap-ng-cli -yes 1 addKey "
        f"applicationList/1sample/test1/options name 'Application Test 1' "
        f"applicationList/1sample/test1/options description 'A simple application displaying authenticated user' "
        f"applicationList/1sample/test1/options display auto "
        f"applicationList/1sample/test1/options logo demo.png "
        f"applicationList/1sample/test1/options uri 'http://test1.{ssodomain}/'"
    ])
    # app2
    run_command([
        "podman", "exec", "lemonldapng-app",
        "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1",
        "addKey", "applicationList/1sample/test2", "type", "application"
    ])
    run_command([
        "podman", "exec", "lemonldapng-app", "bash", "-c",
        f"/usr/share/lemonldap-ng/bin/lemonldap-ng-cli -yes 1 addKey "
        f"applicationList/1sample/test2/options name 'Application Test 2' "
        f"applicationList/1sample/test2/options description 'The same simple application displaying authenticated user' "
        f"applicationList/1sample/test2/options display auto "
        f"applicationList/1sample/test2/options logo thumbnail.png "
        f"applicationList/1sample/test2/options uri 'http://test2.{ssodomain}/'"
    ])
    print("Sample applications successfully created.")


def remove_sample_apps():
    # respect toggle unless forced
    if os.getenv("SAMPLE_APPS_STATUS", "True") == "True" and not args.force:
        print("SAMPLE_APPS_STATUS is still enabled. Use --force to override removal.")
        sys.exit(0)

    print("Removing sample applications...")
    run_command([
        "podman", "exec", "lemonldapng-app",
        "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1",
        "delKey", "applicationList/1sample/test2"
    ])
    run_command([
        "podman", "exec", "lemonldapng-app",
        "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1",
        "delKey", "applicationList/1sample/test1"
    ])
    run_command([
        "podman", "exec", "lemonldapng-app",
        "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1",
        "delKey", "applicationList/1sample"
    ])
    print("Sample applications successfully removed.")


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="Manage LemonLDAP::NG sample apps based on toggle."
    )
    parser.add_argument(
        "mode",
        nargs="?",
        choices=["add", "remove"],
        default="add",
        help="Action to perform (default: add)"
    )
    parser.add_argument(
        "--force",
        action="store_true",
        help="Override SAMPLE_APPS_STATUS check"
    )
    args = parser.parse_args()

    load_env()

    if args.mode == "add":
        add_sample_apps()
    elif args.mode == "remove":
        remove_sample_apps()

