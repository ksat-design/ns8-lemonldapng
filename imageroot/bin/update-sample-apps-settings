#!/usr/bin/env python3
#
# Copyright (C) 2025 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

import os
import sys
import subprocess

def add_sample_apps(lemdomain):
    """Add 'Sample applications' category with Test 1 and Test 2."""
    command = [
        "podman", "exec", "lemonldapng-app",
        "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1", "addKey",
        "applicationList/applications1", "type", "category",
        "applicationList/applications1", "catname", "Sample applications",

        "applicationList/applications1/sample", "type", "application",
        "applicationList/applications1/sample/options", "description", "A sample application",
        "applicationList/applications1/sample/options", "display", "on",
        "applicationList/applications1/sample/options", "logo", "demo.png",
        "applicationList/applications1/sample/options", "name", "Test 1",
        "applicationList/applications1/sample/options", "uri", f"https://test1.{lemdomain}/",

        "applicationList/applications1/sample2", "type", "application",
        "applicationList/applications1/sample2/options", "description", "A sample application",
        "applicationList/applications1/sample2/options", "display", "on",
        "applicationList/applications1/sample2/options", "logo", "demo.png",
        "applicationList/applications1/sample2/options", "name", "Test 2",
        "applicationList/applications1/sample2/options", "uri", f"https://test2.{lemdomain}/"
    ]

    try:
        subprocess.run(command, check=True)
        print("Sample applications added successfully.", file=sys.stderr)
    except subprocess.CalledProcessError as e:
        print(f"Failed to add sample applications: {e}", file=sys.stderr)
        sys.exit(1)

def remove_sample_apps():
    """Remove 'Sample applications' category and its apps."""
    command = [
        "podman", "exec", "lemonldapng-app",
        "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1", "delKey",
        "applicationList/applications1", "sample",
        "applicationList/applications1", "sample2",
        "applicationList", "applications1"
    ]

    try:
        subprocess.run(command, check=True)
        print("Sample applications removed successfully.", file=sys.stderr)
    except subprocess.CalledProcessError as e:
        print(f"Failed to remove sample applications: {e}", file=sys.stderr)
        sys.exit(1)

# Environment variable check
sample_apps_enabled = os.getenv("SAMPLE_APPS_ENABLED", "False") == "True"
lemdomain = os.getenv("LEM_DOMAIN", "example.com")

if sample_apps_enabled:
    print("Sample applications enabled, adding...", file=sys.stderr)
    add_sample_apps(lemdomain)
else:
    print("Sample applications disabled, removing...", file=sys.stderr)
    remove_sample_apps()
