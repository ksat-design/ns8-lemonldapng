#!/usr/bin/env python3

#
# Copyright (C) 2025 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

import os
import subprocess
import sys

# Check whether sample apps should be enabled
apps_enabled = os.getenv("SAMPLE_APPS_ENABLED", "False") == "True"

def get_domain():
    """Fetch the configured domain from LemonLDAP::NG."""
    result = subprocess.run(
        [
            "podman", "exec", "lemonldapng-app",
            "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1", "get", "domain"
        ],
        capture_output=True, text=True, check=True
    )
    return result.stdout.strip().replace("domain = ", "")

if apps_enabled:
    print("Sample apps are enabled. Creating entries...", file=sys.stderr)
    domain = get_domain()
    
    # Create category
    subprocess.run([
        "podman", "exec", "lemonldapng-app",
        "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1", "set",
        "applicationList/1sample/type", "category",
        "applicationList/1sample/catname", "Sample applications"
    ], check=True)
    
    # Create test1 application
    subprocess.run([
        "podman", "exec", "lemonldapng-app",
        "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1", "set",
        "applicationList/1sample/test1/type", "application",
        "applicationList/1sample/test1/options/name", "Application Test 1",
        "applicationList/1sample/test1/options/description", "A simple application displaying authenticated user",
        "applicationList/1sample/test1/options/display", "auto",
        "applicationList/1sample/test1/options/logo", "demo.png",
        "applicationList/1sample/test1/options/uri", f"http://test1.{domain}"
    ], check=True)
    
    # Create test2 application
    subprocess.run([
        "podman", "exec", "lemonldapng-app",
        "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1", "set",
        "applicationList/1sample/test2/type", "application",
        "applicationList/1sample/test2/options/name", "Application Test 2",
        "applicationList/1sample/test2/options/description", "The same simple application displaying authenticated user",
        "applicationList/1sample/test2/options/display", "auto",
        "applicationList/1sample/test2/options/logo", "thumbnail.png",
        "applicationList/1sample/test2/options/uri", f"http://test2.{domain}/"
    ], check=True)

else:
    print("Sample apps are disabled. Removing entries...", file=sys.stderr)
    keys_to_delete = [
        "applicationList/1sample/test1",
        "applicationList/1sample/test2",
        "applicationList/1sample/make",
        "applicationList/1sample"  # This removes the entire category
    ]
    for key in keys_to_delete:
        command = [
            "podman", "exec", "lemonldapng-app",
            "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1", "delKey", key
        ]
        subprocess.run(command, check=True)
