#!/usr/bin/env python3

#
# Copyright (C) 2025 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

import sys
import os
import subprocess

# Check whether sample apps are enabled
sample_apps_env = os.getenv("SAMPLE_APPS_STATUS", "True")

# Define the podman exec base command for LemonLDAP::NG CLI
cli = [
    "podman", "exec", "lemonldapng-app",
    "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1"
]

if sample_apps_env == "True":
    lemdomain = os.getenv('lemdomain')

    if lemdomain:
        command = [
            *cli, 
            "addKey",
            "applicationList/1sample", "type", "category",
            "applicationList/1sample", "catname", "Sample applications",
            "applicationList/1sample/test1", "options", "description", "A simple application displaying authenticated user",
            "applicationList/1sample/test1", "options", "display", "auto",
            "applicationList/1sample/test1", "options", "logo", "demo.png",
            "applicationList/1sample/test1", "options", "name", "Test 1",
            "applicationList/1sample/test1", "options", "uri", f"https://test1.{lemdomain}/",
            "applicationList/1sample/test2", "type", "application",
            "applicationList/1sample/test2", "options", "description", "A simple application displaying authenticated user",
            "applicationList/1sample/test2", "options", "display", "auto",
            "applicationList/1sample/test2", "options", "logo", "demo.png",
            "applicationList/1sample/test2", "options", "name", "Test 2",
            "applicationList/1sample/test2", "options", "uri", f"https://test2.{lemdomain}/"
        ]
        subprocess.run(command, check=True)
    else:
        print("The 'lemdomain' environment variable is not set!", file=sys.stderr)

else:
    # Only remove if explicitly disabled
    print("Sample apps are disabled. Removing entries...", file=sys.stderr)

    remove_command = [
        *cli, 
        "delKey",
        "applicationList/1sample", "test1",
        "applicationList/1sample", "test2",
        "applicationList", "1sample"
    ]
    subprocess.run(remove_command, check=True)
