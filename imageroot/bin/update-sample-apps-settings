#!/usr/bin/env python3
import subprocess
import sys

def get_domain():
    try:
        result = subprocess.run(
            [
                "podman", "exec", "lemonldapng-app",
                "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1", "get", "domain"
            ],
            check=True,
            capture_output=True,
            text=True
        )
        for line in result.stdout.splitlines():
            if line.startswith("domain"):
                return line.split("= ")[1].strip()
    except subprocess.CalledProcessError as e:
        print(f"Error retrieving domain: {e.stderr}", file=sys.stderr)
        sys.exit(1)

def enable_sample_apps():
    print("Sample apps are enabled. Creating category...", file=sys.stderr)
    subprocess.run([
        "podman", "exec", "lemonldapng-app",
        "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1",
        "addKey", "applicationList/applications", "type", "category",
        "applicationList/applications", "catname", "Sample applications"
    ], check=True)

def disable_sample_apps():
    print("Sample apps are disabled. Removing category...", file=sys.stderr)
    subprocess.run([
        "podman", "exec", "lemonldapng-app",
        "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1",
        "delKey", "applicationList", "1sample"
    ], check=True)

def main():
    if len(sys.argv) != 2 or sys.argv[1] not in ("on", "off"):
        print("Usage: toggle_sample_apps.py [on|off]", file=sys.stderr)
        sys.exit(1)

    domain = get_domain()
    print(f"Detected LemonLDAP::NG domain: {domain}", file=sys.stderr)

    if sys.argv[1] == "on":
        enable_sample_apps()
    else:
        disable_sample_apps()

if __name__ == "__main__":
    main()
