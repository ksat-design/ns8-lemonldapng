#!/usr/bin/env python3

#
# Copyright (C) 2025 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

import subprocess
import sys

def get_lemdomain():
    """Get LemonLDAP domain using CLI."""
    try:
        result = subprocess.run(
            [
                "podman", "exec", "lemonldapng-app",
                "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1", "get", "domain"
            ],
            capture_output=True, text=True, check=True
        )
        return result.stdout.strip().split("= ")[1]
    except (IndexError, subprocess.CalledProcessError) as e:
        print(f"Error retrieving domain: {e}", file=sys.stderr)
        sys.exit(1)

# Get domain
lemdomain = get_lemdomain()
print(f"Domain retrieved: {lemdomain}", file=sys.stderr)

# Set portal branding and options
set_command = [
    "podman", "exec", "lemonldapng-app",
    "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1", "set",
    "portalMainLogo", "CustomTheme/nethserver.png",
    "portalCustomCss", "CustomTheme/custom.css",
    "portalFavicon", "CustomTheme/favicon.ico",
    "portalSkinBackground", "nethbackground.png",
    "portalDisplayRegister", "0"
]

# Delete sample applications category and apps
del_command = [
    "podman", "exec", "lemonldapng-app",
    "/usr/share/lemonldap-ng/bin/lemonldap-ng-cli", "-yes", "1", "delKey",
    "applicationList/1sample", "test1",
    "applicationList/1sample", "test2",
    "applicationList", "1sample"
]

try:
    subprocess.run(set_command, check=True)
    subprocess.run(del_command, check=True)
    print("Portal settings applied and sample apps removed.", file=sys.stderr)
except subprocess.CalledProcessError as e:
    print(f"Error executing command: {e}", file=sys.stderr)
    sys.exit(1)
